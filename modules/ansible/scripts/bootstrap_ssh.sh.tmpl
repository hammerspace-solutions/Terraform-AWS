#!/bin/bash

# Passed from Terraform and are used to set the SSH keys into the
# authorized keys file

TARGET_USER='${TARGET_USER}'
TARGET_HOME='${TARGET_HOME}'
SSH_KEYS='${SSH_KEYS}'

# We might need to do the same SSH keys into the root user as well

ROOT_USER='${ROOT_USER}'
ROOT_HOME='${ROOT_HOME}'

echo "Starting bootstrap process..."

# --- SSH Key Management for additional keys ---

if [ -n "$${SSH_KEYS}" ]; then
    echo "Starting SSH Key Management Deployment"

    if [ ! -d "$${TARGET_HOME}/.ssh" ]; then
      mkdir -p "$${TARGET_HOME}/.ssh"
      chmod 700 "$${TARGET_HOME}/.ssh"
      touch "$${TARGET_HOME}/.ssh/authorized_keys"
    fi
    
    # Process keys one by one to avoid multi-line issues

    echo "$${SSH_KEYS}" | while read -r key; do
        if [ -n "$${key}" ] && ! grep -qF "$${key}" "$${TARGET_HOME}/.ssh/authorized_keys"; then
            echo "$${key}" >> "$${TARGET_HOME}/.ssh/authorized_keys"
        fi
    done

    chmod 600 "$${TARGET_HOME}/.ssh/authorized_keys"
    chown -R "$${TARGET_USER}:$${TARGET_USER}" "$${TARGET_HOME}/.ssh"
    echo "Ending SSH Key Management Deployment"
fi

# --- SSH Key Management for additional keys (This is ONLY for root) ---

if [ -n "$${SSH_KEYS}" ]; then
    echo "Starting SSH Key Management Deployment for root"

    if [ ! -d "$${ROOT_HOME}/.ssh" ]; then
      mkdir -p "$${ROOT_HOME}/.ssh"
      chmod 700 "$${ROOT_HOME}/.ssh"
      touch "$${ROOT_HOME}/.ssh/authorized_keys"
    fi
    
    # Process keys line by line
    
    echo "$${SSH_KEYS}" | while read -r key; do
        if [ -n "$${key}" ] && ! grep -qF "$${key}" "$${ROOT_HOME}/.ssh/authorized_keys"; then
            echo "$${key}" >> "$${ROOT_HOME}/.ssh/authorized_keys"
        fi
    done

    chmod 600 "$${ROOT_HOME}/.ssh/authorized_keys"
    chown -R "$${ROOT_USER}":"$${ROOT_USER}" "$${ROOT_HOME}/.ssh"
    echo "Ending SSH Key Management Deployment for $${ROOT_USER}"
fi

echo "Ending bootstrap process...."
